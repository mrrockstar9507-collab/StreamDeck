<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>StreamDeck</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f1330">
  <style>
    :root{
      /* brighter neon palette */
      --bg:#0f1330;
      --card:#171d46;
      --text:#f7fbff;
      --muted:#c2cae5;
      --chip:#0f1a58;
      --accent1:#88d0ff;   /* sky */
      --accent2:#ff7fd1;   /* magenta */
      --accent3:#86ffb7;   /* neon green */
      --accent4:#ffd166;   /* warm pop */
      --radius:16px;
      --shadow:0 14px 30px rgba(0,0,0,.35);
      --glow:0 0 20px rgba(136,208,255,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden}
    a{color:inherit}

    .wrap{max-width:1100px;margin:0 auto;padding:22px;position:relative}
    header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    /* Remote power logo */
    .logo{width:52px;height:52px;border-radius:14px;background:radial-gradient(120px 120px at 30% 20%, rgba(255,255,255,.25), transparent 60%), linear-gradient(135deg,var(--accent1),var(--accent2));
          display:grid;place-items:center;cursor:pointer;user-select:none;box-shadow:var(--shadow),var(--glow)}
    .logo svg{width:28px;height:28px;filter:drop-shadow(0 0 6px rgba(255,255,255,.5))}
    h1{margin:0;font-size:1.8rem;letter-spacing:.25px}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    .tabbtn{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:#142066;color:var(--text);cursor:pointer;transition:transform .06s ease, box-shadow .2s ease}
    .tabbtn:hover{transform:translateY(-1px);box-shadow:var(--glow)}
    .tabbtn.active{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#08112e;border:none}

    .panel{display:none}
    .panel.active{display:block}
    .card{background:var(--card);border-radius:var(--radius);border:1px solid rgba(255,255,255,.12);padding:16px;box-shadow:var(--shadow)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input[type="search"],input[type="text"],select{flex:1;min-width:200px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:#0d1a5a;color:#fff;box-shadow:inset 0 0 0 1px rgba(255,255,255,.04)}
    button{padding:12px 16px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--accent2),var(--accent1));color:#07112e;font-weight:800;cursor:pointer;box-shadow:var(--shadow),var(--glow);transition:transform .06s ease}
    button:hover{transform:translateY(-1px)}
    .results{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-top:16px}
    .tile{display:flex;gap:12px;background:#131a5a;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:10px}
    .tile img{width:100px;height:150px;border-radius:10px;object-fit:cover;background:#000}
    .meta{display:flex;flex-direction:column;gap:6px}
    .title{font-weight:800}
    .sub{color:var(--accent1);font-size:.95rem}
    .providers{display:flex;flex-wrap:wrap;gap:6px}
    .chip{background:var(--chip);padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);font-size:.85rem}
    .links{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .linkbtn{font-size:.85rem;background:#0e1a66;color:var(--text);border:1px solid rgba(255,255,255,.18);padding:6px 10px;border-radius:999px;text-decoration:none;box-shadow:var(--glow)}
    .note{color:var(--muted);font-size:.9rem;margin-top:8px}

    /* Brighter “hot” chips for genres */
    .chips{display:none;flex-wrap:wrap;gap:10px;margin-top:12px}
    .chips.show{display:flex}
    .gchip{background:linear-gradient(135deg,var(--accent3),var(--accent4));color:#06132c;border:none;padding:10px 14px;border-radius:999px;cursor:pointer;box-shadow:0 8px 20px rgba(255,209,102,.25), 0 0 18px rgba(134,255,183,.25);transition:transform .06s ease, filter .15s ease}
    .gchip:hover{transform:translateY(-1px);filter:brightness(1.05)}
    .gchip.active{outline:2px solid rgba(255,255,255,.35)}

    /* Actor section headings */
    .section-title{margin:18px 0 6px;font-weight:900;color:var(--accent3);text-transform:uppercase;letter-spacing:.06em;font-size:.95rem}
    .small{font-size:.9rem;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div id="homeLogo" class="logo" title="Home">
        <!-- Remote power icon -->
        <svg viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M12 2 v8"></path>
          <path d="M5.5 5.5a8 8 0 1 0 13 0"></path>
        </svg>
      </div>
      <h1>StreamDeck</h1>
    </header>

    <div class="tabs">
      <button class="tabbtn active" data-tab="search">Search</button>
      <button class="tabbtn" data-tab="service">By Service</button>
      <button class="tabbtn" data-tab="genres">Browse by Genre</button>
      <button class="tabbtn" data-tab="actors">Browse by Actor</button>
    </div>

    <!-- SEARCH -->
    <section id="search" class="panel active">
      <div class="card">
        <div class="row" style="margin-bottom:10px">
          <input id="q" type="search" placeholder="Search movies or TV shows…">
          <select id="searchType">
            <option value="multi" selected>All</option>
            <option value="movie">Movies</option>
            <option value="tv">TV</option>
          </select>
          <button id="go">Search</button>
        </div>
        <div id="searchResults" class="results"></div>
      </div>
    </section>

    <!-- BY SERVICE (type + genre) -->
    <section id="service" class="panel">
      <div class="card">
        <div class="row" style="margin-bottom:10px">
          <select id="servicePicker">
            <option>Netflix</option><option>Hulu</option><option>Disney+</option><option>Max</option>
            <option>Amazon Prime Video</option><option>Apple TV+</option><option>Peacock</option>
            <option>Paramount+</option><option>Crunchyroll</option>
          </select>
          <select id="serviceType">
            <option value="movie" selected>Movies</option>
            <option value="tv">TV</option>
          </select>
          <select id="serviceGenre">
            <option value="">Any genre</option>
          </select>
          <input id="serviceQuery" type="search" placeholder="Optional: filter by title…">
          <button id="serviceGo">Search This Service</button>
        </div>
        <div class="small">Filters titles available on the selected service in your region (US). Combine with type + genre (+ optional title).</div>
        <div id="serviceResults" class="results"></div>
      </div>
    </section>

    <!-- GENRES (hidden until Show) -->
    <section id="genres" class="panel">
      <div class="card">
        <div class="row" style="margin-bottom:10px">
          <select id="genreType">
            <option value="movie" selected>Movies</option>
            <option value="tv">TV</option>
          </select>
          <button id="showGenresBtn">Show genres</button>
        </div>
        <div id="genreChips" class="chips"></div>
        <div id="genreResults" class="results"></div>
        <div class="note">Press <em>Show genres</em> to reveal chips. Click a chip to load titles.</div>
      </div>
    </section>

    <!-- ACTORS (now with main vs appearance breakdowns) -->
    <section id="actors" class="panel">
      <div class="card">
        <div class="row" style="margin-bottom:10px">
          <input id="actorQuery" type="text" placeholder="Search for an actor…">
          <button id="actorGo">Find Actor</button>
        </div>

        <div id="actorList" class="results" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr))"></div>

        <div id="actorBreakdowns" style="margin-top:14px">
          <!-- Filled dynamically: Movies (Main), Movies (Appearances), TV (Main), TV (Appearances) -->
        </div>
      </div>
    </section>

    <div class="note">Provider buttons open the service’s own search for the title. Availability varies by region/account.</div>
  </div>

  <script>
    /* ========= CONFIG / HELPERS ========= */
    const TMDB_TOKEN = "eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI2NGIzNmM0ZDNjODJlMmRiYzIyNjQzOTNhZjFlZTU2YyIsIm5iZiI6MTc1Njc2NTU2NS4zNzY5OTk5LCJzdWIiOiI2OGI2MWQ3ZDM1MGMzZWVlZTViNGZhZTQiLCJzY29wZXMiOlsiYXBpX3JlYWQiXSwidmVyc2lvbiI6MX0.hdDZK83KYkHjo_zpD0SHKH0K86IeLkwIiBpWVmOzgww";
    const TMDB_BASE = "https://api.themoviedb.org/3";
    const REGION = "US";
    const auth = { headers: { Authorization: `Bearer ${TMDB_TOKEN}` } };

    const poster = (p, size="w185") => p ? `https://image.tmdb.org/t/p/${size}${p}` : "https://via.placeholder.com/100x150?text=No+Image";
    const yearOf = (d) => d ? (d.split("-")[0]||"") : "";
    const safe = (s) => (s||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const norm = (name) => (name||"").replace(/\s*\+\s*/g,"+").replace(/ plus$/i,"+").replace(/\s+/g," ").trim();

    function directSearchURL(providerName, title){
      const n = norm(providerName), q = encodeURIComponent(title);
      if (n==="Netflix") return `https://www.netflix.com/search?q=${q}`;
      if (n==="Hulu") return `https://www.hulu.com/search?q=${q}`;
      if (n==="Disney+") return `https://www.disneyplus.com/search?q=${q}`;
      if (n==="Peacock") return `https://www.peacocktv.com/search?q=${q}`;
      if (n==="Paramount+") return `https://www.paramountplus.com/search/?q=${q}`;
      if (n==="Crunchyroll") return `https://www.crunchyroll.com/search?from=&q=${q}`;
      if (n==="Amazon Prime Video") return `https://www.amazon.com/s?k=${q}&i=instant-video`;
      if (n==="Apple TV+") return `https://tv.apple.com/us/search?term=${q}`;
      if (n==="Max") return `https://www.google.com/search?q=site:max.com+${q}`;
      return `https://www.google.com/search?q=${encodeURIComponent('"'+title+'" '+n+' watch')}`;
    }

    async function getProviders(id, media){ // movie|tv
      const r = await fetch(`${TMDB_BASE}/${media}/${id}/watch/providers`, auth);
      return r.json();
    }

    function providerButtons(title, provUS){
      const combined = [...(provUS.flatrate||[]), ...(provUS.buy||[]), ...(provUS.rent||[])];
      const seen = new Set();
      const btns = [];
      combined.forEach(p=>{
        const key = norm(p.provider_name).toLowerCase();
        if(seen.has(key)) return;
        seen.add(key);
        btns.push(`<a class="linkbtn" target="_blank" rel="noopener" href="${directSearchURL(p.provider_name, title)}">${safe(p.provider_name)}</a>`);
      });
      btns.push(`<a class="linkbtn" target="_blank" rel="noopener" href="https://www.google.com/search?q=${encodeURIComponent(`"${title}" watch`)}">All providers</a>`);
      return btns.join("");
    }

    function resultTile(item, prov){
      const title = item.title || item.name || "Untitled";
      const media = item.media_type || (item.first_air_date ? "tv" : "movie");
      const y = yearOf(item.release_date || item.first_air_date);
      const us = prov?.results?.[REGION] || {};
      return `
        <div class="tile">
          <img src="${poster(item.poster_path)}" alt="">
          <div class="meta">
            <div class="title">${safe(title)}</div>
            <div class="sub">${media.toUpperCase()} ${y ? "· "+y : ""}</div>
            <div class="providers">${
              (us.flatrate||[]).length ? us.flatrate.map(p=>`<span class="chip">${safe(p.provider_name)}</span>`).join("") : `<span class="chip">No subscription info</span>`
            }</div>
            <div class="links">
              ${us.link ? `<a class="linkbtn" target="_blank" rel="noopener" href="${us.link}">Watch options</a>` : ""}
              ${providerButtons(title, us)}
            </div>
          </div>
        </div>`;
    }

    /* ========= SEARCH ========= */
    async function doSearch(){
      const q = document.getElementById("q").value.trim();
      if(!q) return;
      const type = document.getElementById("searchType").value;
      const out = document.getElementById("searchResults");
      out.innerHTML = "<div class='small'>Searching…</div>";
      const endpoint = type==="movie"?"search/movie":type==="tv"?"search/tv":"search/multi";
      const data = await fetch(`${TMDB_BASE}/${endpoint}?query=${encodeURIComponent(q)}`, auth).then(r=>r.json());
      out.innerHTML = "";
      const items = (data.results||[]).filter(x => (x.title||x.name) && (x.media_type!=="person"));
      if(!items.length){ out.innerHTML = "<div class='small'>No results.</div>"; return; }
      for(const it of items){
        const media = it.media_type || (it.first_air_date ? "tv" : "movie");
        const prov = await getProviders(it.id, media);
        out.insertAdjacentHTML("beforeend", resultTile(it, prov));
      }
    }

    /* ========= GENRES ========= */
    async function loadGenresIfNeeded(){
      if (window.__genresLoaded) return;
      const [gm, gt] = await Promise.all([
        fetch(`${TMDB_BASE}/genre/movie/list`, auth).then(r=>r.json()),
        fetch(`${TMDB_BASE}/genre/tv/list`, auth).then(r=>r.json())
      ]);
      window.__genres = { movie:(gm.genres||[]), tv:(gt.genres||[]) };
      window.__genresLoaded = true;
    }
    function renderGenreChips(){
      const type = document.getElementById("genreType").value;
      const holder = document.getElementById("genreChips");
      holder.classList.add("show");
      holder.innerHTML = "";
      (window.__genres?.[type] || []).forEach(g=>{
        const b = document.createElement("button");
        b.className = "gchip";
        b.textContent = g.name;
        b.addEventListener("click", ()=>{ [...holder.children].forEach(c=>c.classList.remove("active")); b.classList.add("active"); discoverByGenre(type, g.id); });
        holder.appendChild(b);
      });
    }
    async function discoverByGenre(type, genreId){
      const out = document.getElementById("genreResults");
      out.innerHTML = "<div class='small'>Loading…</div>";
      const data = await fetch(`${TMDB_BASE}/discover/${type}?with_genres=${genreId}&sort_by=popularity.desc`, auth).then(r=>r.json());
      out.innerHTML = "";
      for(const it of (data.results||[])){
        const prov = await getProviders(it.id, type);
        out.insertAdjacentHTML("beforeend", resultTile({...it, media_type:type}, prov));
      }
    }

    /* ========= BY SERVICE ========= */
    async function loadProviderIds(){
      if (window.__provLoaded) return;
      const [pm, pt] = await Promise.all([
        fetch(`${TMDB_BASE}/watch/providers/movie?watch_region=${REGION}`, auth).then(r=>r.json()),
        fetch(`${TMDB_BASE}/watch/providers/tv?watch_region=${REGION}`, auth).then(r=>r.json())
      ]);
      const mk = (arr)=>{ const m={}; (arr||[]).forEach(p=> m[norm(p.provider_name)] = p.provider_id); return m; };
      window.__provMovie = mk(pm.results||[]);
      window.__provTV = mk(pt.results||[]);
      window.__provLoaded = true;
    }
    async function populateServiceGenres(){
      await loadGenresIfNeeded();
      const type = document.getElementById("serviceType").value;
      const sel = document.getElementById("serviceGenre");
      sel.innerHTML = `<option value="">Any genre</option>`;
      (window.__genres?.[type]||[]).forEach(g=>{
        const o = document.createElement("option"); o.value=g.id; o.textContent=g.name; sel.appendChild(o);
      });
    }
    async function doServiceSearch(){
      await loadProviderIds(); await populateServiceGenres();
      const serviceName = norm(document.getElementById("servicePicker").value);
      const type = document.getElementById("serviceType").value;
      const genreId = document.getElementById("serviceGenre").value;
      const keyword = document.getElementById("serviceQuery").value.trim();
      const out = document.getElementById("serviceResults");
      out.innerHTML = `<div class='small'>Searching ${safe(serviceName)} ${type.toUpperCase()}…</div>`;
      const provId = (type==="movie"?window.__provMovie:window.__provTV)[serviceName];
      if(!provId){ out.innerHTML = `<div class='small'>Provider not supported for ${type.toUpperCase()} in ${REGION}.</div>`; return; }
      let url = `${TMDB_BASE}/discover/${type}?watch_region=${REGION}&with_watch_providers=${provId}&sort_by=popularity.desc`;
      if (genreId) url += `&with_genres=${genreId}`;
      if (keyword) url += `&with_keywords=${encodeURIComponent(keyword)}`;
      const data = await fetch(url, auth).then(r=>r.json());
      out.innerHTML = "";
      const items = data.results||[];
      if(!items.length){ out.innerHTML = `<div class='small'>No results.</div>`; return; }
      for(const it of items.slice(0,40)){
        const prov = await getProviders(it.id, type);
        out.insertAdjacentHTML("beforeend", resultTile({...it, media_type:type}, prov));
      }
    }

    /* ========= ACTORS — breakdowns ========= */
    function isMainRole(castItem){
      // Heuristic: TMDB 'order' indicates billing. 0–5 ~ main cast.
      return typeof castItem.order === "number" ? castItem.order <= 5 : false;
    }
    function splitRoles(credits){
      const movies = (credits.cast||[]).filter(r => r.media_type === "movie");
      const tvs    = (credits.cast||[]).filter(r => r.media_type === "tv");
      const out = {
        movie:{ main:[], appearances:[] },
        tv:{ main:[], appearances:[] }
      };
      movies.forEach(r => (isMainRole(r) ? out.movie.main : out.movie.appearances).push(r));
      tvs.forEach(r    => (isMainRole(r) ? out.tv.main    : out.tv.appearances   ).push(r));
      // sort by popularity (desc)
      ["movie","tv"].forEach(k=>{
        out[k].main.sort((a,b)=>(b.popularity||0)-(a.popularity||0));
        out[k].appearances.sort((a,b)=>(b.popularity||0)-(a.popularity||0));
      });
      return out;
    }
    function sectionGrid(items, media){
      if(!items.length) return `<div class="small">No titles.</div>`;
      const cards = items.slice(0,24).map(it=>({ ...it, media_type:media }));
      return cards.map(it=>`<div>${resultTile(it, window.__provCache?.[`${media}-${it.id}`]||{})}</div>`).join("");
    }
    async function renderActorBreakdowns(personId, personName){
      const mount = document.getElementById("actorBreakdowns");
      mount.innerHTML = `<div class='small'>Loading ${safe(personName)}’s roles…</div>`;
      const credits = await fetch(`${TMDB_BASE}/person/${personId}/combined_credits`, auth).then(r=>r.json());
      const split = splitRoles(credits);
      // Preload provider data (simple cache to speed render)
      window.__provCache = window.__provCache || {};
      const allToFetch = [
        ...split.movie.main, ...split.movie.appearances,
        ...split.tv.main,    ...split.tv.appearances
      ].slice(0,72); // cap for speed
      await Promise.all(allToFetch.map(async it=>{
        const key = `${it.media_type}-${it.id}`;
        if(!window.__provCache[key]){
          window.__provCache[key] = await getProviders(it.id, it.media_type);
        }
      }));

      // Build 4 sections
      mount.innerHTML = `
        <div class="section-title">Movies — Main roles</div>
        <div class="results">${sectionGrid(split.movie.main, "movie")}</div>

        <div class="section-title">Movies — Appearances</div>
        <div class="results">${sectionGrid(split.movie.appearances, "movie")}</div>

        <div class="section-title">TV — Main roles</div>
        <div class="results">${sectionGrid(split.tv.main, "tv")}</div>

        <div class="section-title">TV — Appearances</div>
        <div class="results">${sectionGrid(split.tv.appearances, "tv")}</div>
      `;
    }
    async function searchActors(){
      const q = document.getElementById("actorQuery").value.trim();
      if(!q) return;
      const list = document.getElementById("actorList");
      const res = await fetch(`${TMDB_BASE}/search/person?query=${encodeURIComponent(q)}`, auth).then(r=>r.json());
      const people = res.results || [];
      list.innerHTML = "";
      document.getElementById("actorBreakdowns").innerHTML = "";
      if(!people.length){ list.innerHTML = "<div class='small'>No actors found.</div>"; return; }
      people.slice(0,12).forEach(p=>{
        const card = document.createElement("div");
        card.className = "tile";
        card.innerHTML = `
          <img src="${poster(p.profile_path)}" alt="">
          <div class="meta">
            <div class="title">${safe(p.name)}</div>
            <div class="sub">${(p.known_for_department||'').toUpperCase()}</div>
            <div class="small">${(p.known_for||[]).filter(x=>x.title||x.name).slice(0,2).map(x=>safe(x.title||x.name)).join(" • ")}</div>
          </div>`;
        card.addEventListener("click", ()=>renderActorBreakdowns(p.id, p.name));
        list.appendChild(card);
      });
    }

    /* ========= TABS & HOME ========= */
    function activateTab(id){
      document.querySelectorAll(".tabbtn").forEach(x=>x.classList.toggle("active", x.dataset.tab===id));
      document.querySelectorAll(".panel").forEach(p=>p.classList.toggle("active", p.id===id));
      window.scrollTo({top:0,behavior:"smooth"});
    }
    document.querySelectorAll(".tabbtn").forEach(b=>{
      b.addEventListener("click", ()=>{
        activateTab(b.dataset.tab);
        if(b.dataset.tab==="service"){ populateServiceGenres(); }
      });
    });
    document.getElementById("homeLogo").addEventListener("click", ()=>{
      activateTab("search");
      document.getElementById("q").value="";
      document.getElementById("searchResults").innerHTML="";
    });

    /* ========= EVENT WIRING ========= */
    document.getElementById("go").addEventListener("click", doSearch);
    document.getElementById("q").addEventListener("keydown", e=>{ if(e.key==="Enter") doSearch(); });

    document.getElementById("serviceType").addEventListener("change", populateServiceGenres);
    document.getElementById("serviceGo").addEventListener("click", doServiceSearch);
    document.getElementById("serviceQuery").addEventListener("keydown", e=>{ if(e.key==="Enter") doServiceSearch(); });

    document.getElementById("showGenresBtn").addEventListener("click", async ()=>{ await loadGenresIfNeeded(); renderGenreChips(); });
    document.getElementById("genreType").addEventListener("change", ()=>{ if(window.__genresLoaded && document.getElementById("genreChips").classList.contains("show")) renderGenreChips(); });

    // Pre-seed service genres
    populateServiceGenres();
  </script>

  <!-- PWA SW registration; bump query to bust cache if updating -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js?v=streamdeck-actors-main-vs-appear-1').catch(()=>{});
    }
  </script>
</body>
</html>
